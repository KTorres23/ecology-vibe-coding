<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Check iNaturalist Species Status</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px;}
    textarea { width: 100%; height: 150px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f2f2f2; }
    a { color: #0366d6; text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <h1>Check iNaturalist Species Status</h1>
  <p>Enter species names (one per line):</p>
  <textarea id="speciesInput" placeholder="e.g., Danaus plexippus or Monarch Butterfly"></textarea><br />
  <button onclick="checkINaturalist()">Check iNaturalist</button>

  <table id="resultsTable" style="display:none;">
    <thead>
      <tr>
        <th rowspan="2">Observation Link</th>
        <th colspan="2">Name Info</th>
        <th rowspan="2">Observations Count</th>
        <th colspan="2">Additional Info</th>
        <th colspan="2">Validation Info</th>
      </tr>
      <tr>
        <th>Species Name</th>
        <th>Common Name</th>
        <th>iNat ID #</th>
        <th># of Taxonomic changes</th>
        <th>entered_term</th>
        <th>matched_term</th>
      </tr>
    </thead>
    <tbody id="resultsBody">
    </tbody>
  </table>

  <script>
  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function fetchSpeciesData(species) {
    try {
      const searchUrl = `https://api.inaturalist.org/v1/taxa/autocomplete?q=${encodeURIComponent(species)}&per_page=1&rank=species`;
      const response = await fetch(searchUrl);
      if (!response.ok) throw new Error(`API request failed (status ${response.status}) for species: ${species}`);
      const data = await response.json();
      if (data.results.length === 0) return null;

      const taxon = data.results[0];
      const ancestors = Array.isArray(taxon.ancestors) ? taxon.ancestors : [];
      const observationsCount = taxon.observations_count.toLocaleString("en-US") || NA;
      
      const matchedTerm = taxon.matched_term || NA;
      const sppName = taxon.name || NA;
      const commonName = taxon.preferred_common_name;
      const idNum = taxon.id;
      const taxChanges = taxon.taxon_changes_count;
      const enteredTerm = species;

      const obsLink = `https://www.inaturalist.org/observations?taxon_id=${taxon.id}`;

      return { obsLink, name, observationsCount, matchedTerm, sppName, commonName, idNum, taxChanges, enteredTerm };
    } catch (err) {
      console.error(`Error fetching data for species "${species}": `, err);
      throw err;
    }
  }

  async function checkINaturalist() {
    const input = document.getElementById("speciesInput").value.trim();
    const speciesList = input.split("\n").map(s => s.trim()).filter(s => s.length > 0);
    const table = document.getElementById("resultsTable");
    const tbody = document.getElementById("resultsBody");

    tbody.innerHTML = "";
    if (speciesList.length === 0) {
      alert("Please enter at least one species name.");
      table.style.display = "none";
      return;
    }
    table.style.display = "table";

    for (const species of speciesList) {
      try {
        const data = await fetchSpeciesData(species);
        if (data === null) {
          tbody.innerHTML += `<tr><td colspan="6">Species not found: ${species}</td></tr>`;
        } else {
          tbody.innerHTML += `
            <tr>
              <td><a href="${data.obsLink}" target="_blank" rel="noopener noreferrer">View Observations</a></td>
              <td>${data.sppName}</td>
              <td>${data.commonName}</td>
              <td>${data.observationsCount}</td>
              <td>${data.idNum}</td>
              <td>${data.taxChanges}</td>
              <td>${data.matchedTerm}</td>
              <td>${data.enteredTerm}</td>
            </tr>`;
        }
      } catch {
        tbody.innerHTML += `<tr><td colspan="6">Error checking species: ${species}</td></tr>`;
      }

      // Pause 300ms between requests to prevent flooding API
      await sleep(300);
    }
  }
</script>

</body>
</html>
